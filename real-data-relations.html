<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çœŸå®æ•°æ®ä¸€å¯¹å¤šå…³ç³»ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .status-bar {
            background: #f8f9fa;
            padding: 15px 30px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #28a745;
        }

        .status-indicator.error {
            background: #dc3545;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            font-weight: 500;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: white;
            border-bottom-color: #667eea;
            color: #667eea;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .summary-card h3 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .summary-card p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-box::after {
            content: 'ğŸ”';
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 12px;
        }

        .table-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #000;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #495057;
        }

        .form-group select,
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group select:focus,
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }

        .empty-state img {
            width: 100px;
            opacity: 0.5;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .tab-content {
                padding: 20px;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                min-width: auto;
            }

            table {
                font-size: 14px;
            }

            th, td {
                padding: 10px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>çœŸå®æ•°æ®ä¸€å¯¹å¤šå…³ç³»ç®¡ç†ç³»ç»Ÿ</h1>
            <p>è®¾å¤‡ã€æ™ºèƒ½ä½“ã€å­¦ç”Ÿå…³ç³»ç®¡ç†ä¸æ•°æ®åˆ†æå¹³å°</p>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-indicator" id="dbStatus"></div>
                <span id="dbStatusText">æ•°æ®åº“è¿æ¥æ£€æŸ¥ä¸­...</span>
            </div>
            <div class="status-item">
                <span id="lastUpdate">æœ€åæ›´æ–°: --</span>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('overview')">æ¦‚è§ˆ</div>
            <div class="tab" onclick="showTab('devices')">è®¾å¤‡ç®¡ç†</div>
            <div class="tab" onclick="showTab('agents')">æ™ºèƒ½ä½“ç®¡ç†</div>
            <div class="tab" onclick="showTab('students')">å­¦ç”Ÿç®¡ç†</div>
            <div class="tab" onclick="showTab('relations')">ç»‘å®šå…³ç³»</div>
            <div class="tab" onclick="showTab('statistics')">èŠå¤©ç»Ÿè®¡</div>
        </div>

        <!-- æ¦‚è§ˆæ ‡ç­¾é¡µ -->
        <div id="overview" class="tab-content active">
            <div class="summary-grid" id="summaryGrid">
                <div class="summary-card">
                    <h3 id="totalDevices">--</h3>
                    <p>æ€»è®¾å¤‡æ•°</p>
                </div>
                <div class="summary-card">
                    <h3 id="boundDevices">--</h3>
                    <p>å·²ç»‘å®šè®¾å¤‡</p>
                </div>
                <div class="summary-card">
                    <h3 id="totalAgents">--</h3>
                    <p>æ™ºèƒ½ä½“æ•°é‡</p>
                </div>
                <div class="summary-card">
                    <h3 id="totalStudents">--</h3>
                    <p>å­¦ç”Ÿæ•°é‡</p>
                </div>
                <div class="summary-card">
                    <h3 id="chatsToday">--</h3>
                    <p>ä»Šæ—¥èŠå¤©</p>
                </div>
                <div class="summary-card">
                    <h3 id="chatsWeek">--</h3>
                    <p>æœ¬å‘¨èŠå¤©</p>
                </div>
            </div>

            <h3>æœ€è¿‘æ´»åŠ¨</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>æ—¶é—´</th>
                            <th>è®¾å¤‡</th>
                            <th>å­¦ç”Ÿ</th>
                            <th>æ™ºèƒ½ä½“</th>
                            <th>å†…å®¹</th>
                        </tr>
                    </thead>
                    <tbody id="recentActivities">
                        <tr>
                            <td colspan="5" class="loading">åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- è®¾å¤‡ç®¡ç†æ ‡ç­¾é¡µ -->
        <div id="devices" class="tab-content">
            <div class="controls">
                <div class="search-box">
                    <input type="text" id="deviceSearch" placeholder="æœç´¢è®¾å¤‡MACåœ°å€ã€åˆ«åæˆ–å­¦ç”Ÿå§“å...">
                </div>
                <button class="btn btn-primary" onclick="refreshDevices()">åˆ·æ–°æ•°æ®</button>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>è®¾å¤‡ID</th>
                            <th>MACåœ°å€</th>
                            <th>åˆ«å</th>
                            <th>ç»‘å®šçŠ¶æ€</th>
                            <th>ç»‘å®šå­¦ç”Ÿ</th>
                            <th>æ™ºèƒ½ä½“</th>
                            <th>æœ€åè¿æ¥</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="devicesTable">
                        <tr>
                            <td colspan="8" class="loading">åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- æ™ºèƒ½ä½“ç®¡ç†æ ‡ç­¾é¡µ -->
        <div id="agents" class="tab-content">
            <div class="controls">
                <div class="search-box">
                    <input type="text" id="agentSearch" placeholder="æœç´¢æ™ºèƒ½ä½“åç§°æˆ–ä»£ç ...">
                </div>
                <button class="btn btn-primary" onclick="refreshAgents()">åˆ·æ–°æ•°æ®</button>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>æ™ºèƒ½ä½“ID</th>
                            <th>åç§°</th>
                            <th>ä»£ç </th>
                            <th>è¯­è¨€</th>
                            <th>è®¾å¤‡æ•°é‡</th>
                            <th>ç³»ç»Ÿæç¤º</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                        </tr>
                    </thead>
                    <tbody id="agentsTable">
                        <tr>
                            <td colspan="7" class="loading">åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- å­¦ç”Ÿç®¡ç†æ ‡ç­¾é¡µ -->
        <div id="students" class="tab-content">
            <div class="controls">
                <div class="search-box">
                    <input type="text" id="studentSearch" placeholder="æœç´¢å­¦ç”Ÿå§“åã€ç”¨æˆ·åæˆ–å­¦æ ¡...">
                </div>
                <button class="btn btn-primary" onclick="refreshStudents()">åˆ·æ–°æ•°æ®</button>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>å­¦ç”ŸID</th>
                            <th>ç”¨æˆ·å</th>
                            <th>çœŸå®å§“å</th>
                            <th>å­¦æ ¡</th>
                            <th>å¹´çº§</th>
                            <th>ç­çº§</th>
                            <th>è®¾å¤‡æ•°é‡</th>
                            <th>æ³¨å†Œæ—¶é—´</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTable">
                        <tr>
                            <td colspan="8" class="loading">åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ç»‘å®šå…³ç³»æ ‡ç­¾é¡µ -->
        <div id="relations" class="tab-content">
            <div class="controls">
                <div class="search-box">
                    <input type="text" id="relationSearch" placeholder="æœç´¢è®¾å¤‡ã€å­¦ç”Ÿæˆ–æ™ºèƒ½ä½“...">
                </div>
                <button class="btn btn-primary" onclick="refreshRelations()">åˆ·æ–°æ•°æ®</button>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>è®¾å¤‡MAC</th>
                            <th>è®¾å¤‡åˆ«å</th>
                            <th>å­¦ç”Ÿå§“å</th>
                            <th>å­¦æ ¡</th>
                            <th>ç­çº§</th>
                            <th>æ™ºèƒ½ä½“</th>
                            <th>ç»‘å®šæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="relationsTable">
                        <tr>
                            <td colspan="8" class="loading">åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- èŠå¤©ç»Ÿè®¡æ ‡ç­¾é¡µ -->
        <div id="statistics" class="tab-content">
            <h3>æ¯æ—¥èŠå¤©ç»Ÿè®¡</h3>
            <div class="table-container" style="margin-bottom: 30px;">
                <table>
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>æ€»èŠå¤©æ•°</th>
                            <th>æ´»è·ƒè®¾å¤‡</th>
                            <th>æ´»è·ƒå­¦ç”Ÿ</th>
                            <th>æ´»è·ƒæ™ºèƒ½ä½“</th>
                        </tr>
                    </thead>
                    <tbody id="dailyStatsTable">
                        <tr>
                            <td colspan="5" class="loading">åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3>è®¾å¤‡èŠå¤©æ’è¡Œ</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>è®¾å¤‡MAC</th>
                            <th>è®¾å¤‡åˆ«å</th>
                            <th>å­¦ç”Ÿå§“å</th>
                            <th>æ™ºèƒ½ä½“</th>
                            <th>èŠå¤©æ¬¡æ•°</th>
                            <th>æœ€åèŠå¤©</th>
                        </tr>
                    </thead>
                    <tbody id="deviceStatsTable">
                        <tr>
                            <td colspan="6" class="loading">åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ç»‘å®šè®¾å¤‡æ¨¡æ€æ¡† -->
    <div id="bindModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ç»‘å®šè®¾å¤‡</h2>
                <span class="close" onclick="closeModal('bindModal')">&times;</span>
            </div>
            <form id="bindForm">
                <div class="form-group">
                    <label>è®¾å¤‡ID:</label>
                    <input type="text" id="bindDeviceId" readonly>
                </div>
                <div class="form-group">
                    <label>é€‰æ‹©å­¦ç”Ÿ:</label>
                    <select id="bindStudentId" required>
                        <option value="">è¯·é€‰æ‹©å­¦ç”Ÿ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>é€‰æ‹©æ™ºèƒ½ä½“:</label>
                    <select id="bindAgentId">
                        <option value="">è¯·é€‰æ‹©æ™ºèƒ½ä½“</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å¤‡æ³¨:</label>
                    <textarea id="bindRemark" rows="3" placeholder="å¯é€‰å¤‡æ³¨ä¿¡æ¯"></textarea>
                </div>
                <div style="text-align: right;">
                    <button type="button" class="btn" onclick="closeModal('bindModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ç¡®è®¤ç»‘å®š</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // APIåŸºç¡€åœ°å€
        const API_BASE = 'http://localhost:8091/api';
        
        // å…¨å±€æ•°æ®å­˜å‚¨
        let devicesData = [];
        let agentsData = [];
        let studentsData = [];
        let relationsData = [];
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            checkHealth();
            loadAllData();
            setupSearchFilters();
        });

        // æ£€æŸ¥APIå¥åº·çŠ¶æ€
        async function checkHealth() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                const statusIndicator = document.getElementById('dbStatus');
                const statusText = document.getElementById('dbStatusText');
                
                if (data.status === 'healthy') {
                    statusIndicator.className = 'status-indicator';
                    statusText.textContent = 'æ•°æ®åº“è¿æ¥æ­£å¸¸';
                } else {
                    statusIndicator.className = 'status-indicator error';
                    statusText.textContent = 'æ•°æ®åº“è¿æ¥å¼‚å¸¸';
                }
                
                document.getElementById('lastUpdate').textContent = `æœ€åæ›´æ–°: ${new Date().toLocaleString()}`;
            } catch (error) {
                console.error('å¥åº·æ£€æŸ¥å¤±è´¥:', error);
                document.getElementById('dbStatus').className = 'status-indicator error';
                document.getElementById('dbStatusText').textContent = 'è¿æ¥å¤±è´¥';
            }
        }

        // åŠ è½½æ‰€æœ‰æ•°æ®
        async function loadAllData() {
            await Promise.all([
                loadSummary(),
                loadDevices(),
                loadAgents(),
                loadStudents(),
                loadRelations(),
                loadStatistics()
            ]);
        }

        // åŠ è½½æ¦‚è§ˆæ•°æ®
        async function loadSummary() {
            try {
                const response = await fetch(`${API_BASE}/summary`);
                const result = await response.json();
                
                if (result.success) {
                    const summary = result.data.summary;
                    document.getElementById('totalDevices').textContent = summary.total_devices || 0;
                    document.getElementById('boundDevices').textContent = summary.bound_devices || 0;
                    document.getElementById('totalAgents').textContent = summary.total_agents || 0;
                    document.getElementById('totalStudents').textContent = summary.total_students || 0;
                    document.getElementById('chatsToday').textContent = summary.chats_today || 0;
                    document.getElementById('chatsWeek').textContent = summary.chats_week || 0;
                    
                    // åŠ è½½æœ€è¿‘æ´»åŠ¨
                    const activitiesTable = document.getElementById('recentActivities');
                    if (result.data.recent_activities && result.data.recent_activities.length > 0) {
                        activitiesTable.innerHTML = result.data.recent_activities.map(activity => `
                            <tr>
                                <td>${activity.created_at || '--'}</td>
                                <td>${activity.device_mac || '--'}</td>
                                <td>${activity.student_name || '--'}</td>
                                <td>${activity.agent_name || '--'}</td>
                                <td>${activity.content || '--'}</td>
                            </tr>
                        `).join('');
                    } else {
                        activitiesTable.innerHTML = '<tr><td colspan="5" class="empty-state">æš‚æ— æœ€è¿‘æ´»åŠ¨</td></tr>';
                    }
                }
            } catch (error) {
                console.error('åŠ è½½æ¦‚è§ˆæ•°æ®å¤±è´¥:', error);
                showError('æ¦‚è§ˆæ•°æ®åŠ è½½å¤±è´¥');
            }
        }

        // åŠ è½½è®¾å¤‡æ•°æ®
        async function loadDevices() {
            try {
                const response = await fetch(`${API_BASE}/devices`);
                const result = await response.json();
                
                if (result.success) {
                    devicesData = result.data;
                    renderDevicesTable(devicesData);
                }
            } catch (error) {
                console.error('åŠ è½½è®¾å¤‡æ•°æ®å¤±è´¥:', error);
                document.getElementById('devicesTable').innerHTML = '<tr><td colspan="8" class="error">è®¾å¤‡æ•°æ®åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        // æ¸²æŸ“è®¾å¤‡è¡¨æ ¼
        function renderDevicesTable(devices) {
            const table = document.getElementById('devicesTable');
            
            if (devices.length === 0) {
                table.innerHTML = '<tr><td colspan="8" class="empty-state">æš‚æ— è®¾å¤‡æ•°æ®</td></tr>';
                return;
            }
            
            table.innerHTML = devices.map(device => `
                <tr>
                    <td>${device.id}</td>
                    <td>${device.mac_address}</td>
                    <td>${device.alias || '--'}</td>
                    <td><span class="badge ${device.bind_status === 1 ? 'badge-success' : 'badge-warning'}">${device.bind_status_text}</span></td>
                    <td>${device.student_name || '--'}</td>
                    <td>${device.agent_name || '--'}</td>
                    <td>${device.last_connected_at || '--'}</td>
                    <td>
                        ${device.bind_status === 1 
                            ? `<button class="btn btn-danger btn-sm" onclick="unbindDevice('${device.id}')">è§£ç»‘</button>`
                            : `<button class="btn btn-success btn-sm" onclick="showBindModal('${device.id}')">ç»‘å®š</button>`
                        }
                    </td>
                </tr>
            `).join('');
        }

        // åŠ è½½æ™ºèƒ½ä½“æ•°æ®
        async function loadAgents() {
            try {
                const response = await fetch(`${API_BASE}/agents`);
                const result = await response.json();
                
                if (result.success) {
                    agentsData = result.data;
                    renderAgentsTable(agentsData);
                }
            } catch (error) {
                console.error('åŠ è½½æ™ºèƒ½ä½“æ•°æ®å¤±è´¥:', error);
                document.getElementById('agentsTable').innerHTML = '<tr><td colspan="7" class="error">æ™ºèƒ½ä½“æ•°æ®åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        // æ¸²æŸ“æ™ºèƒ½ä½“è¡¨æ ¼
        function renderAgentsTable(agents) {
            const table = document.getElementById('agentsTable');
            
            if (agents.length === 0) {
                table.innerHTML = '<tr><td colspan="7" class="empty-state">æš‚æ— æ™ºèƒ½ä½“æ•°æ®</td></tr>';
                return;
            }
            
            table.innerHTML = agents.map(agent => `
                <tr>
                    <td>${agent.id}</td>
                    <td>${agent.agent_name || '--'}</td>
                    <td>${agent.agent_code || '--'}</td>
                    <td>${agent.language || '--'}</td>
                    <td><span class="badge badge-info">${agent.device_count}</span></td>
                    <td title="${agent.system_prompt || ''}">${agent.system_prompt_short || '--'}</td>
                    <td>${agent.created_at || '--'}</td>
                </tr>
            `).join('');
        }

        // åŠ è½½å­¦ç”Ÿæ•°æ®
        async function loadStudents() {
            try {
                const response = await fetch(`${API_BASE}/students`);
                const result = await response.json();
                
                if (result.success) {
                    studentsData = result.data;
                    renderStudentsTable(studentsData);
                    updateStudentOptions();
                }
            } catch (error) {
                console.error('åŠ è½½å­¦ç”Ÿæ•°æ®å¤±è´¥:', error);
                document.getElementById('studentsTable').innerHTML = '<tr><td colspan="8" class="error">å­¦ç”Ÿæ•°æ®åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        // æ¸²æŸ“å­¦ç”Ÿè¡¨æ ¼
        function renderStudentsTable(students) {
            const table = document.getElementById('studentsTable');
            
            if (students.length === 0) {
                table.innerHTML = '<tr><td colspan="8" class="empty-state">æš‚æ— å­¦ç”Ÿæ•°æ®</td></tr>';
                return;
            }
            
            table.innerHTML = students.map(student => `
                <tr>
                    <td>${student.id}</td>
                    <td>${student.username}</td>
                    <td>${student.real_name || '--'}</td>
                    <td>${student.school_name || '--'}</td>
                    <td>${student.current_grade || '--'}</td>
                    <td>${student.class_name || '--'}</td>
                    <td><span class="badge badge-info">${student.device_count}</span></td>
                    <td>${student.create_date || '--'}</td>
                </tr>
            `).join('');
        }

        // åŠ è½½ç»‘å®šå…³ç³»æ•°æ®
        async function loadRelations() {
            try {
                const response = await fetch(`${API_BASE}/bind-relations`);
                const result = await response.json();
                
                if (result.success) {
                    relationsData = result.data;
                    renderRelationsTable(relationsData);
                }
            } catch (error) {
                console.error('åŠ è½½ç»‘å®šå…³ç³»å¤±è´¥:', error);
                document.getElementById('relationsTable').innerHTML = '<tr><td colspan="8" class="error">ç»‘å®šå…³ç³»æ•°æ®åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        // æ¸²æŸ“ç»‘å®šå…³ç³»è¡¨æ ¼
        function renderRelationsTable(relations) {
            const table = document.getElementById('relationsTable');
            
            if (relations.length === 0) {
                table.innerHTML = '<tr><td colspan="8" class="empty-state">æš‚æ— ç»‘å®šå…³ç³»</td></tr>';
                return;
            }
            
            table.innerHTML = relations.map(relation => `
                <tr>
                    <td>${relation.mac_address}</td>
                    <td>${relation.device_alias || '--'}</td>
                    <td>${relation.student_name || '--'}</td>
                    <td>${relation.school_name || '--'}</td>
                    <td>${relation.class_name || '--'}</td>
                    <td>${relation.agent_name || '--'}</td>
                    <td>${relation.bind_time || '--'}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="unbindDevice('${relation.device_id}')">è§£ç»‘</button>
                    </td>
                </tr>
            `).join('');
        }

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStatistics() {
            try {
                const response = await fetch(`${API_BASE}/chat-statistics`);
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    
                    // æ¸²æŸ“æ¯æ—¥ç»Ÿè®¡
                    const dailyTable = document.getElementById('dailyStatsTable');
                    if (data.daily_statistics && data.daily_statistics.length > 0) {
                        dailyTable.innerHTML = data.daily_statistics.map(stat => `
                            <tr>
                                <td>${stat.chat_date}</td>
                                <td>${stat.total_chats}</td>
                                <td>${stat.active_devices}</td>
                                <td>${stat.active_students}</td>
                                <td>${stat.active_agents}</td>
                            </tr>
                        `).join('');
                    } else {
                        dailyTable.innerHTML = '<tr><td colspan="5" class="empty-state">æš‚æ— ç»Ÿè®¡æ•°æ®</td></tr>';
                    }
                    
                    // æ¸²æŸ“è®¾å¤‡ç»Ÿè®¡
                    const deviceTable = document.getElementById('deviceStatsTable');
                    if (data.device_statistics && data.device_statistics.length > 0) {
                        deviceTable.innerHTML = data.device_statistics.map(stat => `
                            <tr>
                                <td>${stat.mac_address}</td>
                                <td>${stat.alias || '--'}</td>
                                <td>${stat.student_name || '--'}</td>
                                <td>${stat.agent_name || '--'}</td>
                                <td><span class="badge badge-info">${stat.chat_count}</span></td>
                                <td>${stat.last_chat_time || '--'}</td>
                            </tr>
                        `).join('');
                    } else {
                        deviceTable.innerHTML = '<tr><td colspan="6" class="empty-state">æš‚æ— è®¾å¤‡ç»Ÿè®¡</td></tr>';
                    }
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
            }
        }

        // æ ‡ç­¾é¡µåˆ‡æ¢
        function showTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeç±»
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µå†…å®¹
            document.getElementById(tabName).classList.add('active');
            
            // æ·»åŠ activeç±»åˆ°é€‰ä¸­çš„æ ‡ç­¾
            event.target.classList.add('active');
        }

        // è®¾ç½®æœç´¢è¿‡æ»¤å™¨
        function setupSearchFilters() {
            document.getElementById('deviceSearch').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const filteredDevices = devicesData.filter(device => 
                    device.mac_address.toLowerCase().includes(searchTerm) ||
                    (device.alias && device.alias.toLowerCase().includes(searchTerm)) ||
                    (device.student_name && device.student_name.toLowerCase().includes(searchTerm))
                );
                renderDevicesTable(filteredDevices);
            });

            document.getElementById('agentSearch').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const filteredAgents = agentsData.filter(agent => 
                    (agent.agent_name && agent.agent_name.toLowerCase().includes(searchTerm)) ||
                    (agent.agent_code && agent.agent_code.toLowerCase().includes(searchTerm))
                );
                renderAgentsTable(filteredAgents);
            });

            document.getElementById('studentSearch').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const filteredStudents = studentsData.filter(student => 
                    student.username.toLowerCase().includes(searchTerm) ||
                    (student.real_name && student.real_name.toLowerCase().includes(searchTerm)) ||
                    (student.school_name && student.school_name.toLowerCase().includes(searchTerm))
                );
                renderStudentsTable(filteredStudents);
            });

            document.getElementById('relationSearch').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const filteredRelations = relationsData.filter(relation => 
                    relation.mac_address.toLowerCase().includes(searchTerm) ||
                    (relation.student_name && relation.student_name.toLowerCase().includes(searchTerm)) ||
                    (relation.agent_name && relation.agent_name.toLowerCase().includes(searchTerm))
                );
                renderRelationsTable(filteredRelations);
            });
        }

        // åˆ·æ–°æ•°æ®å‡½æ•°
        function refreshDevices() {
            loadDevices();
        }

        function refreshAgents() {
            loadAgents();
        }

        function refreshStudents() {
            loadStudents();
        }

        function refreshRelations() {
            loadRelations();
        }

        // æ˜¾ç¤ºç»‘å®šæ¨¡æ€æ¡†
        function showBindModal(deviceId) {
            document.getElementById('bindDeviceId').value = deviceId;
            updateStudentOptions();
            updateAgentOptions();
            document.getElementById('bindModal').style.display = 'block';
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // æ›´æ–°å­¦ç”Ÿé€‰é¡¹
        function updateStudentOptions() {
            const select = document.getElementById('bindStudentId');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©å­¦ç”Ÿ</option>';
            
            studentsData.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.real_name || student.username} (${student.username})`;
                select.appendChild(option);
            });
        }

        // æ›´æ–°æ™ºèƒ½ä½“é€‰é¡¹
        function updateAgentOptions() {
            const select = document.getElementById('bindAgentId');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©æ™ºèƒ½ä½“</option>';
            
            agentsData.forEach(agent => {
                const option = document.createElement('option');
                option.value = agent.id;
                option.textContent = `${agent.agent_name} (${agent.agent_code})`;
                select.appendChild(option);
            });
        }

        // ç»‘å®šè®¾å¤‡
        document.getElementById('bindForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const deviceId = document.getElementById('bindDeviceId').value;
            const studentId = document.getElementById('bindStudentId').value;
            const agentId = document.getElementById('bindAgentId').value;
            const remark = document.getElementById('bindRemark').value;
            
            if (!studentId) {
                alert('è¯·é€‰æ‹©å­¦ç”Ÿ');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/device/${deviceId}/bind`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        student_id: studentId,
                        agent_id: agentId,
                        remark: remark
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('è®¾å¤‡ç»‘å®šæˆåŠŸ');
                    closeModal('bindModal');
                    loadDevices();
                    loadRelations();
                    loadSummary();
                } else {
                    alert('ç»‘å®šå¤±è´¥: ' + result.error);
                }
            } catch (error) {
                console.error('ç»‘å®šè®¾å¤‡å¤±è´¥:', error);
                alert('ç»‘å®šå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        });

        // è§£ç»‘è®¾å¤‡
        async function unbindDevice(deviceId) {
            if (!confirm('ç¡®å®šè¦è§£ç»‘æ­¤è®¾å¤‡å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/device/${deviceId}/unbind`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        remark: 'é€šè¿‡Webç•Œé¢è§£ç»‘'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('è®¾å¤‡è§£ç»‘æˆåŠŸ');
                    loadDevices();
                    loadRelations();
                    loadSummary();
                } else {
                    alert('è§£ç»‘å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                console.error('è§£ç»‘è®¾å¤‡å¤±è´¥:', error);
                alert('è§£ç»‘å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            console.error(message);
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>