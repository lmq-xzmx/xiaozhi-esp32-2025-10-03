<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁúüÂÆûÊï∞ÊçÆ‰∏ÄÂØπÂ§öÂÖ≥Á≥ªÁÆ°ÁêÜÁ≥ªÁªü</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .status-bar {
            background: #f8f9fa;
            padding: 15px 30px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #28a745;
        }

        .status-indicator.error {
            background: #dc3545;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            font-weight: 500;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: white;
            border-bottom-color: #667eea;
            color: #667eea;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .summary-card h3 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .summary-card p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-box::after {
            content: 'üîç';
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 12px;
        }

        .table-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #000;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #495057;
        }

        .form-group select,
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group select:focus,
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }

        .empty-state img {
            width: 100px;
            opacity: 0.5;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .tab-content {
                padding: 20px;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                min-width: auto;
            }

            table {
                font-size: 14px;
            }

            th, td {
                padding: 10px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ÁúüÂÆûÊï∞ÊçÆ‰∏ÄÂØπÂ§öÂÖ≥Á≥ªÁÆ°ÁêÜÁ≥ªÁªü</h1>
            <p>ËÆæÂ§á„ÄÅÊô∫ËÉΩ‰Ωì„ÄÅÂ≠¶ÁîüÂÖ≥Á≥ªÁÆ°ÁêÜ‰∏éÊï∞ÊçÆÂàÜÊûêÂπ≥Âè∞</p>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-indicator" id="dbStatus"></div>
                <span id="dbStatusText">Êï∞ÊçÆÂ∫ìËøûÊé•Ê£ÄÊü•‰∏≠...</span>
            </div>
            <div class="status-item">
                <span id="lastUpdate">ÊúÄÂêéÊõ¥Êñ∞: --</span>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('overview')">Ê¶ÇËßà</div>
            <div class="tab" onclick="showTab('devices')">ËÆæÂ§áÁÆ°ÁêÜ</div>
            <div class="tab" onclick="showTab('agents')">Êô∫ËÉΩ‰ΩìÁÆ°ÁêÜ</div>
            <div class="tab" onclick="showTab('students')">Â≠¶ÁîüÁÆ°ÁêÜ</div>
            <div class="tab" onclick="showTab('relations')">ÁªëÂÆöÂÖ≥Á≥ª</div>
            <div class="tab" onclick="showTab('statistics')">ËÅäÂ§©ÁªüËÆ°</div>
        </div>

        <!-- Ê¶ÇËßàÊ†áÁ≠æÈ°µ -->
        <div id="overview" class="tab-content active">
            <div class="summary-grid" id="summaryGrid">
                <div class="summary-card">
                    <h3 id="totalDevices">--</h3>
                    <p>ÊÄªËÆæÂ§áÊï∞</p>
                </div>
                <div class="summary-card">
                    <h3 id="boundDevices">--</h3>
                    <p>Â∑≤ÁªëÂÆöËÆæÂ§á</p>
                </div>
                <div class="summary-card">
                    <h3 id="totalAgents">--</h3>
                    <p>Êô∫ËÉΩ‰ΩìÊï∞Èáè</p>
                </div>
                <div class="summary-card">
                    <h3 id="totalStudents">--</h3>
                    <p>Â≠¶ÁîüÊï∞Èáè</p>
                </div>
                <div class="summary-card">
                    <h3 id="chatsToday">--</h3>
                    <p>‰ªäÊó•ËÅäÂ§©</p>
                </div>
                <div class="summary-card">
                    <h3 id="chatsWeek">--</h3>
                    <p>Êú¨Âë®ËÅäÂ§©</p>
                </div>
            </div>

            <h3>ÊúÄËøëÊ¥ªÂä®</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Êó∂Èó¥</th>
                            <th>ËÆæÂ§á</th>
                            <th>Â≠¶Áîü</th>
                            <th>Êô∫ËÉΩ‰Ωì</th>
                            <th>ÂÜÖÂÆπ</th>
                        </tr>
                    </thead>
                    <tbody id="recentActivities">
                        <tr>
                            <td colspan="5" class="loading">Âä†ËΩΩ‰∏≠...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ËÆæÂ§áÁÆ°ÁêÜÊ†áÁ≠æÈ°µ -->
        <div id="devices" class="tab-content">
            <div class="controls">
                <div class="search-box">
                    <input type="text" id="deviceSearch" placeholder="ÊêúÁ¥¢ËÆæÂ§áMACÂú∞ÂùÄ„ÄÅÂà´ÂêçÊàñÂ≠¶ÁîüÂßìÂêç...">
                </div>
                <button class="btn btn-primary" onclick="refreshDevices()">Âà∑Êñ∞Êï∞ÊçÆ</button>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ËÆæÂ§áID</th>
                            <th>MACÂú∞ÂùÄ</th>
                            <th>Âà´Âêç</th>
                            <th>ÁªëÂÆöÁä∂ÊÄÅ</th>
                            <th>ÁªëÂÆöÂ≠¶Áîü</th>
                            <th>Êô∫ËÉΩ‰Ωì</th>
                            <th>ÊúÄÂêéËøûÊé•</th>
                            <th>Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody id="devicesTable">
                        <tr>
                            <td colspan="8" class="loading">Âä†ËΩΩ‰∏≠...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Êô∫ËÉΩ‰ΩìÁÆ°ÁêÜÊ†áÁ≠æÈ°µ -->
        <div id="agents" class="tab-content">
            <div class="controls">
                <div class="search-box">
                    <input type="text" id="agentSearch" placeholder="ÊêúÁ¥¢Êô∫ËÉΩ‰ΩìÂêçÁß∞Êàñ‰ª£Á†Å...">
                </div>
                <button class="btn btn-primary" onclick="refreshAgents()">Âà∑Êñ∞Êï∞ÊçÆ</button>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Êô∫ËÉΩ‰ΩìID</th>
                            <th>ÂêçÁß∞</th>
                            <th>‰ª£Á†Å</th>
                            <th>ËØ≠Ë®Ä</th>
                            <th>ËÆæÂ§áÊï∞Èáè</th>
                            <th>Á≥ªÁªüÊèêÁ§∫</th>
                            <th>ÂàõÂª∫Êó∂Èó¥</th>
                        </tr>
                    </thead>
                    <tbody id="agentsTable">
                        <tr>
                            <td colspan="7" class="loading">Âä†ËΩΩ‰∏≠...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Â≠¶ÁîüÁÆ°ÁêÜÊ†áÁ≠æÈ°µ -->
        <div id="students" class="tab-content">
            <div class="controls">
                <div class="search-box">
                    <input type="text" id="studentSearch" placeholder="ÊêúÁ¥¢Â≠¶ÁîüÂßìÂêç„ÄÅÁî®Êà∑ÂêçÊàñÂ≠¶Ê†°...">
                </div>
                <button class="btn btn-primary" onclick="refreshStudents()">Âà∑Êñ∞Êï∞ÊçÆ</button>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Â≠¶ÁîüID</th>
                            <th>Áî®Êà∑Âêç</th>
                            <th>ÁúüÂÆûÂßìÂêç</th>
                            <th>Â≠¶Ê†°</th>
                            <th>Âπ¥Á∫ß</th>
                            <th>Áè≠Á∫ß</th>
                            <th>ËÆæÂ§áÊï∞Èáè</th>
                            <th>Ê≥®ÂÜåÊó∂Èó¥</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTable">
                        <tr>
                            <td colspan="8" class="loading">Âä†ËΩΩ‰∏≠...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ÁªëÂÆöÂÖ≥Á≥ªÊ†áÁ≠æÈ°µ -->
        <div id="relations" class="tab-content">
            <div class="controls">
                <div class="search-box">
                    <input type="text" id="relationSearch" placeholder="ÊêúÁ¥¢ËÆæÂ§á„ÄÅÂ≠¶ÁîüÊàñÊô∫ËÉΩ‰Ωì...">
                </div>
                <button class="btn btn-primary" onclick="refreshRelations()">Âà∑Êñ∞Êï∞ÊçÆ</button>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ËÆæÂ§áMAC</th>
                            <th>ËÆæÂ§áÂà´Âêç</th>
                            <th>Â≠¶ÁîüÂßìÂêç</th>
                            <th>Â≠¶Ê†°</th>
                            <th>Áè≠Á∫ß</th>
                            <th>Êô∫ËÉΩ‰Ωì</th>
                            <th>ÁªëÂÆöÊó∂Èó¥</th>
                            <th>Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody id="relationsTable">
                        <tr>
                            <td colspan="8" class="loading">Âä†ËΩΩ‰∏≠...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ËÅäÂ§©ÁªüËÆ°Ê†áÁ≠æÈ°µ -->
        <div id="statistics" class="tab-content">
            <h3>ÊØèÊó•ËÅäÂ§©ÁªüËÆ°</h3>
            <div class="table-container" style="margin-bottom: 30px;">
                <table>
                    <thead>
                        <tr>
                            <th>Êó•Êúü</th>
                            <th>ÊÄªËÅäÂ§©Êï∞</th>
                            <th>Ê¥ªË∑ÉËÆæÂ§á</th>
                            <th>Ê¥ªË∑ÉÂ≠¶Áîü</th>
                            <th>Ê¥ªË∑ÉÊô∫ËÉΩ‰Ωì</th>
                        </tr>
                    </thead>
                    <tbody id="dailyStatsTable">
                        <tr>
                            <td colspan="5" class="loading">Âä†ËΩΩ‰∏≠...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3>ËÆæÂ§áËÅäÂ§©ÊéíË°å</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ËÆæÂ§áMAC</th>
                            <th>ËÆæÂ§áÂà´Âêç</th>
                            <th>Â≠¶ÁîüÂßìÂêç</th>
                            <th>Êô∫ËÉΩ‰Ωì</th>
                            <th>ËÅäÂ§©Ê¨°Êï∞</th>
                            <th>ÊúÄÂêéËÅäÂ§©</th>
                        </tr>
                    </thead>
                    <tbody id="deviceStatsTable">
                        <tr>
                            <td colspan="6" class="loading">Âä†ËΩΩ‰∏≠...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ÁªëÂÆöËÆæÂ§áÊ®°ÊÄÅÊ°Ü -->
    <div id="bindModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ÁªëÂÆöËÆæÂ§á</h2>
                <span class="close" onclick="closeModal('bindModal')">&times;</span>
            </div>
            <form id="bindForm">
                <div class="form-group">
                    <label>ËÆæÂ§áID:</label>
                    <input type="text" id="bindDeviceId" readonly>
                </div>
                <div class="form-group">
                    <label>ÈÄâÊã©Â≠¶Áîü:</label>
                    <select id="bindStudentId" required>
                        <option value="">ËØ∑ÈÄâÊã©Â≠¶Áîü</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ÈÄâÊã©Êô∫ËÉΩ‰Ωì:</label>
                    <select id="bindAgentId">
                        <option value="">ËØ∑ÈÄâÊã©Êô∫ËÉΩ‰Ωì</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Â§áÊ≥®:</label>
                    <textarea id="bindRemark" rows="3" placeholder="ÂèØÈÄâÂ§áÊ≥®‰ø°ÊÅØ"></textarea>
                </div>
                <div style="text-align: right;">
                    <button type="button" class="btn" onclick="closeModal('bindModal')">ÂèñÊ∂à</button>
                    <button type="submit" class="btn btn-primary">Á°ÆËÆ§ÁªëÂÆö</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // APIÂü∫Á°ÄÂú∞ÂùÄ
        const API_BASE = 'http://localhost:8091/api';
        
        // ÂÖ®Â±ÄÊï∞ÊçÆÂ≠òÂÇ®
        let devicesData = [];
        let agentsData = [];
        let studentsData = [];
        let relationsData = [];
        
        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            checkHealth();
            loadAllData();
            setupSearchFilters();
        });

        // Ê£ÄÊü•APIÂÅ•Â∫∑Áä∂ÊÄÅ
        async function checkHealth() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                const statusIndicator = document.getElementById('dbStatus');
                const statusText = document.getElementById('dbStatusText');
                
                if (data.status === 'healthy') {
                    statusIndicator.className = 'status-indicator';
                    statusText.textContent = 'Êï∞ÊçÆÂ∫ìËøûÊé•Ê≠£Â∏∏';
                } else {
                    statusIndicator.className = 'status-indicator error';
                    statusText.textContent = 'Êï∞ÊçÆÂ∫ìËøûÊé•ÂºÇÂ∏∏';
                }
                
                document.getElementById('lastUpdate').textContent = `ÊúÄÂêéÊõ¥Êñ∞: ${new Date().toLocaleString()}`;
            } catch (error) {
                console.error('ÂÅ•Â∫∑Ê£ÄÊü•Â§±Ë¥•:', error);
                document.getElementById('dbStatus').className = 'status-indicator error';
                document.getElementById('dbStatusText').textContent = 'ËøûÊé•Â§±Ë¥•';
            }
        }

        // Âä†ËΩΩÊâÄÊúâÊï∞ÊçÆ
        async function loadAllData() {
            await Promise.all([
                loadSummary(),
                loadDevices(),
                loadAgents(),
                loadStudents(),
                loadRelations(),
                loadStatistics()
            ]);
        }

        // Âä†ËΩΩÊ¶ÇËßàÊï∞ÊçÆ
        async function loadSummary() {
            try {
                const response = await fetch(`${API_BASE}/summary`);
                const result = await response.json();
                
                if (result.success) {
                    const summary = result.data.summary;
                    document.getElementById('totalDevices').textContent = summary.total_devices || 0;
                    document.getElementById('boundDevices').textContent = summary.bound_devices || 0;
                    document.getElementById('totalAgents').textContent = summary.total_agents || 0;
                    document.getElementById('totalStudents').textContent = summary.total_students || 0;
                    document.getElementById('chatsToday').textContent = summary.chats_today || 0;
                    document.getElementById('chatsWeek').textContent = summary.chats_week || 0;
                    
                    // Âä†ËΩΩÊúÄËøëÊ¥ªÂä®
                    const activitiesTable = document.getElementById('recentActivities');
                    if (result.data.recent_activities && result.data.recent_activities.length > 0) {
                        activitiesTable.innerHTML = result.data.recent_activities.map(activity => `
                            <tr>
                                <td>${activity.created_at || '--'}</td>
                                <td>${activity.device_mac || '--'}</td>
                                <td>${activity.student_name || '--'}</td>
                                <td>${activity.agent_name || '--'}</td>
                                <td>${activity.content || '--'}</td>
                            </tr>
                        `).join('');
                    } else {
                        activitiesTable.innerHTML = '<tr><td colspan="5" class="empty-state">ÊöÇÊó†ÊúÄËøëÊ¥ªÂä®</td></tr>';
                    }
                }
            } catch (error) {
                console.error('Âä†ËΩΩÊ¶ÇËßàÊï∞ÊçÆÂ§±Ë¥•:', error);
                showError('Ê¶ÇËßàÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•');
            }
        }

        // Âä†ËΩΩËÆæÂ§áÊï∞ÊçÆ
        async function loadDevices() {
            try {
                const response = await fetch(`${API_BASE}/devices`);
                const result = await response.json();
                
                if (result.success) {
                    devicesData = result.data;
                    renderDevicesTable(devicesData);
                }
            } catch (error) {
                console.error('Âä†ËΩΩËÆæÂ§áÊï∞ÊçÆÂ§±Ë¥•:', error);
                document.getElementById('devicesTable').innerHTML = '<tr><td colspan="8" class="error">ËÆæÂ§áÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•</td></tr>';
            }
        }

        // Ê∏≤ÊüìËÆæÂ§áË°®Ê†º
        function renderDevicesTable(devices) {
            const table = document.getElementById('devicesTable');
            
            if (devices.length === 0) {
                table.innerHTML = '<tr><td colspan="8" class="empty-state">ÊöÇÊó†ËÆæÂ§áÊï∞ÊçÆ</td></tr>';
                return;
            }
            
            table.innerHTML = devices.map(device => `
                <tr>
                    <td>${device.id}</td>
                    <td>${device.mac_address}</td>
                    <td>${device.alias || '--'}</td>
                    <td><span class="badge ${device.bind_status === 1 ? 'badge-success' : 'badge-warning'}">${device.bind_status_text}</span></td>
                    <td>${device.student_name || '--'}</td>
                    <td>${device.agent_name || '--'}</td>
                    <td>${device.last_connected_at || '--'}</td>
                    <td>
                        ${device.bind_status === 1 
                            ? `<button class="btn btn-danger btn-sm" onclick="unbindDevice('${device.id}')">Ëß£Áªë</button>`
                            : `<button class="btn btn-success btn-sm" onclick="showBindModal('${device.id}')">ÁªëÂÆö</button>`
                        }
                    </td>
                </tr>
            `).join('');
        }

        // Âä†ËΩΩÊô∫ËÉΩ‰ΩìÊï∞ÊçÆ
        async function loadAgents() {
            try {
                const response = await fetch(`${API_BASE}/agents`);
                const result = await response.json();
                
                if (result.success) {
                    agentsData = result.data;
                    renderAgentsTable(agentsData);
                }
            } catch (error) {
                console.error('Âä†ËΩΩÊô∫ËÉΩ‰ΩìÊï∞ÊçÆÂ§±Ë¥•:', error);
                document.getElementById('agentsTable').innerHTML = '<tr><td colspan="7" class="error">Êô∫ËÉΩ‰ΩìÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•</td></tr>';
            }
        }

        // Ê∏≤ÊüìÊô∫ËÉΩ‰ΩìË°®Ê†º
        function renderAgentsTable(agents) {
            const table = document.getElementById('agentsTable');
            
            if (agents.length === 0) {
                table.innerHTML = '<tr><td colspan="7" class="empty-state">ÊöÇÊó†Êô∫ËÉΩ‰ΩìÊï∞ÊçÆ</td></tr>';
                return;
            }
            
            table.innerHTML = agents.map(agent => `
                <tr>
                    <td>${agent.id}</td>
                    <td>${agent.agent_name || '--'}</td>
                    <td>${agent.agent_code || '--'}</td>
                    <td>${agent.language || '--'}</td>
                    <td><span class="badge badge-info">${agent.device_count}</span></td>
                    <td title="${agent.system_prompt || ''}">${agent.system_prompt_short || '--'}</td>
                    <td>${agent.created_at || '--'}</td>
                </tr>
            `).join('');
        }

        // Âä†ËΩΩÂ≠¶ÁîüÊï∞ÊçÆ
        async function loadStudents() {
            try {
                const response = await fetch(`${API_BASE}/students`);
                const result = await response.json();
                
                if (result.success) {
                    studentsData = result.data;
                    renderStudentsTable(studentsData);
                    updateStudentOptions();
                }
            } catch (error) {
                console.error('Âä†ËΩΩÂ≠¶ÁîüÊï∞ÊçÆÂ§±Ë¥•:', error);
                document.getElementById('studentsTable').innerHTML = '<tr><td colspan="8" class="error">Â≠¶ÁîüÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•</td></tr>';
            }
        }

        // Ê∏≤ÊüìÂ≠¶ÁîüË°®Ê†º
        function renderStudentsTable(students) {
            const table = document.getElementById('studentsTable');
            
            if (students.length === 0) {
                table.innerHTML = '<tr><td colspan="8" class="empty-state">ÊöÇÊó†Â≠¶ÁîüÊï∞ÊçÆ</td></tr>';
                return;
            }
            
            table.innerHTML = students.map(student => `
                <tr>
                    <td>${student.id}</td>
                    <td>${student.username}</td>
                    <td>${student.real_name || '--'}</td>
                    <td>${student.school_name || '--'}</td>
                    <td>${student.current_grade || '--'}</td>
                    <td>${student.class_name || '--'}</td>
                    <td><span class="badge badge-info">${student.device_count}</span></td>
                    <td>${student.create_date || '--'}</td>
                </tr>
            `).join('');
        }

        // Âä†ËΩΩÁªëÂÆöÂÖ≥Á≥ªÊï∞ÊçÆ
        async function loadRelations() {
            try {
                const response = await fetch(`${API_BASE}/bind-relations`);
                const result = await response.json();
                
                if (result.success) {
                    relationsData = result.data;
                    renderRelationsTable(relationsData);
                }
            } catch (error) {
                console.error('Âä†ËΩΩÁªëÂÆöÂÖ≥Á≥ªÂ§±Ë¥•:', error);
                document.getElementById('relationsTable').innerHTML = '<tr><td colspan="8" class="error">ÁªëÂÆöÂÖ≥Á≥ªÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•</td></tr>';
            }
        }

        // Ê∏≤ÊüìÁªëÂÆöÂÖ≥Á≥ªË°®Ê†º
        function renderRelationsTable(relations) {
            const table = document.getElementById('relationsTable');
            
            if (relations.length === 0) {
                table.innerHTML = '<tr><td colspan="8" class="empty-state">ÊöÇÊó†ÁªëÂÆöÂÖ≥Á≥ª</td></tr>';
                return;
            }
            
            table.innerHTML = relations.map(relation => `
                <tr>
                    <td>${relation.mac_address}</td>
                    <td>${relation.device_alias || '--'}</td>
                    <td>${relation.student_name || '--'}</td>
                    <td>${relation.school_name || '--'}</td>
                    <td>${relation.class_name || '--'}</td>
                    <td>${relation.agent_name || '--'}</td>
                    <td>${relation.bind_time || '--'}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="unbindDevice('${relation.device_id}')">Ëß£Áªë</button>
                    </td>
                </tr>
            `).join('');
        }

        // Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆ
        async function loadStatistics() {
            try {
                const response = await fetch(`${API_BASE}/chat-statistics`);
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    
                    // Ê∏≤ÊüìÊØèÊó•ÁªüËÆ°
                    const dailyTable = document.getElementById('dailyStatsTable');
                    if (data.daily_statistics && data.daily_statistics.length > 0) {
                        dailyTable.innerHTML = data.daily_statistics.map(stat => `
                            <tr>
                                <td>${stat.chat_date}</td>
                                <td>${stat.total_chats}</td>
                                <td>${stat.active_devices}</td>
                                <td>${stat.active_students}</td>
                                <td>${stat.active_agents}</td>
                            </tr>
                        `).join('');
                    } else {
                        dailyTable.innerHTML = '<tr><td colspan="5" class="empty-state">ÊöÇÊó†ÁªüËÆ°Êï∞ÊçÆ</td></tr>';
                    }
                    
                    // Ê∏≤ÊüìËÆæÂ§áÁªüËÆ°
                    const deviceTable = document.getElementById('deviceStatsTable');
                    if (data.device_statistics && data.device_statistics.length > 0) {
                        deviceTable.innerHTML = data.device_statistics.map(stat => `
                            <tr>
                                <td>${stat.mac_address}</td>
                                <td>${stat.alias || '--'}</td>
                                <td>${stat.student_name || '--'}</td>
                                <td>${stat.agent_name || '--'}</td>
                                <td><span class="badge badge-info">${stat.chat_count}</span></td>
                                <td>${stat.last_chat_time || '--'}</td>
                            </tr>
                        `).join('');
                    } else {
                        deviceTable.innerHTML = '<tr><td colspan="6" class="empty-state">ÊöÇÊó†ËÆæÂ§áÁªüËÆ°</td></tr>';
                    }
                }
            } catch (error) {
                console.error('Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆÂ§±Ë¥•:', error);
            }
        }

        // Ê†áÁ≠æÈ°µÂàáÊç¢
        function showTab(tabName) {
            // ÈöêËóèÊâÄÊúâÊ†áÁ≠æÈ°µÂÜÖÂÆπ
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ÁßªÈô§ÊâÄÊúâÊ†áÁ≠æÁöÑactiveÁ±ª
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ÊòæÁ§∫ÈÄâ‰∏≠ÁöÑÊ†áÁ≠æÈ°µÂÜÖÂÆπ
            document.getElementById(tabName).classList.add('active');
            
            // Ê∑ªÂä†activeÁ±ªÂà∞ÈÄâ‰∏≠ÁöÑÊ†áÁ≠æ
            event.target.classList.add('active');
        }

        // ËÆæÁΩÆÊêúÁ¥¢ËøáÊª§Âô®
        function setupSearchFilters() {
            document.getElementById('deviceSearch').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const filteredDevices = devicesData.filter(device => 
                    device.mac_address.toLowerCase().includes(searchTerm) ||
                    (device.alias && device.alias.toLowerCase().includes(searchTerm)) ||
                    (device.student_name && device.student_name.toLowerCase().includes(searchTerm))
                );
                renderDevicesTable(filteredDevices);
            });

            document.getElementById('agentSearch').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const filteredAgents = agentsData.filter(agent => 
                    (agent.agent_name && agent.agent_name.toLowerCase().includes(searchTerm)) ||
                    (agent.agent_code && agent.agent_code.toLowerCase().includes(searchTerm))
                );
                renderAgentsTable(filteredAgents);
            });

            document.getElementById('studentSearch').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const filteredStudents = studentsData.filter(student => 
                    student.username.toLowerCase().includes(searchTerm) ||
                    (student.real_name && student.real_name.toLowerCase().includes(searchTerm)) ||
                    (student.school_name && student.school_name.toLowerCase().includes(searchTerm))
                );
                renderStudentsTable(filteredStudents);
            });

            document.getElementById('relationSearch').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const filteredRelations = relationsData.filter(relation => 
                    relation.mac_address.toLowerCase().includes(searchTerm) ||
                    (relation.student_name && relation.student_name.toLowerCase().includes(searchTerm)) ||
                    (relation.agent_name && relation.agent_name.toLowerCase().includes(searchTerm))
                );
                renderRelationsTable(filteredRelations);
            });
        }

        // Âà∑Êñ∞Êï∞ÊçÆÂáΩÊï∞
        function refreshDevices() {
            loadDevices();
        }

        function refreshAgents() {
            loadAgents();
        }

        function refreshStudents() {
            loadStudents();
        }

        function refreshRelations() {
            loadRelations();
        }

        // ÊòæÁ§∫ÁªëÂÆöÊ®°ÊÄÅÊ°Ü
        function showBindModal(deviceId) {
            document.getElementById('bindDeviceId').value = deviceId;
            updateStudentOptions();
            updateAgentOptions();
            document.getElementById('bindModal').style.display = 'block';
        }

        // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Êõ¥Êñ∞Â≠¶ÁîüÈÄâÈ°π
        function updateStudentOptions() {
            const select = document.getElementById('bindStudentId');
            select.innerHTML = '<option value="">ËØ∑ÈÄâÊã©Â≠¶Áîü</option>';
            
            studentsData.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.real_name || student.username} (${student.username})`;
                select.appendChild(option);
            });
        }

        // Êõ¥Êñ∞Êô∫ËÉΩ‰ΩìÈÄâÈ°π
        function updateAgentOptions() {
            const select = document.getElementById('bindAgentId');
            select.innerHTML = '<option value="">ËØ∑ÈÄâÊã©Êô∫ËÉΩ‰Ωì</option>';
            
            agentsData.forEach(agent => {
                const option = document.createElement('option');
                option.value = agent.id;
                option.textContent = `${agent.agent_name} (${agent.agent_code})`;
                select.appendChild(option);
            });
        }

        // ÁªëÂÆöËÆæÂ§á
        document.getElementById('bindForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const deviceId = document.getElementById('bindDeviceId').value;
            const studentId = document.getElementById('bindStudentId').value;
            const agentId = document.getElementById('bindAgentId').value;
            const remark = document.getElementById('bindRemark').value;
            
            if (!studentId) {
                alert('ËØ∑ÈÄâÊã©Â≠¶Áîü');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/device/${deviceId}/bind`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        student_id: studentId,
                        agent_id: agentId,
                        remark: remark
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('ËÆæÂ§áÁªëÂÆöÊàêÂäü');
                    closeModal('bindModal');
                    loadDevices();
                    loadRelations();
                    loadSummary();
                } else {
                    alert('ÁªëÂÆöÂ§±Ë¥•: ' + result.error);
                }
            } catch (error) {
                console.error('ÁªëÂÆöËÆæÂ§áÂ§±Ë¥•:', error);
                alert('ÁªëÂÆöÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
            }
        });

        // Ëß£ÁªëËÆæÂ§á
        async function unbindDevice(deviceId) {
            if (!confirm('Á°ÆÂÆöË¶ÅËß£ÁªëÊ≠§ËÆæÂ§áÂêóÔºü')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/device/${deviceId}/unbind`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        remark: 'ÈÄöËøáWebÁïåÈù¢Ëß£Áªë'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('ËÆæÂ§áËß£ÁªëÊàêÂäü');
                    loadDevices();
                    loadRelations();
                    loadSummary();
                } else {
                    alert('Ëß£ÁªëÂ§±Ë¥•: ' + result.error);
                }
            } catch (error) {
                console.error('Ëß£ÁªëËÆæÂ§áÂ§±Ë¥•:', error);
                alert('Ëß£ÁªëÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
            }
        }

        // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
        function showError(message) {
            console.error(message);
        }

        // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>