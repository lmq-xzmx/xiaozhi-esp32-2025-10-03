<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç²¾ç¡®æµç¨‹è°ƒè¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .device-item { padding: 10px; margin: 5px 0; background: #f5f5f5; cursor: pointer; border: 1px solid #ccc; }
        .device-item:hover { background: #e0e0e0; }
        .device-item.active { background: #007bff; color: white; }
        .session-item { padding: 8px; margin: 3px 0; background: #fff; border: 1px solid #ccc; cursor: pointer; }
        .session-item:hover { background: #f0f0f0; }
        .loading-state { text-align: center; padding: 20px; color: #666; }
        .error-state { text-align: center; padding: 20px; color: red; }
        .empty-state { text-align: center; padding: 20px; color: #999; }
        #sessions-list { min-height: 150px; border: 2px solid #007bff; padding: 10px; }
        .debug-log { background: #f8f9fa; padding: 10px; margin: 5px 0; font-family: monospace; font-size: 12px; border-left: 3px solid #007bff; }
        .error-log { border-left-color: red; }
        .success-log { border-left-color: green; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Enhanced Chat Records ç²¾ç¡®æµç¨‹è°ƒè¯•</h1>
        
        <div class="section">
            <h2>1. è®¾å¤‡åˆ—è¡¨</h2>
            <div id="devices-list">åŠ è½½ä¸­...</div>
        </div>

        <div class="section">
            <h2>2. Sessions List (ç²¾ç¡®æ¨¡æ‹Ÿ)</h2>
            <p>å½“å‰è®¾å¤‡: <span id="current-device-info">æ— </span></p>
            <div id="sessions-list">
                <div class="loading-state">è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè®¾å¤‡</div>
            </div>
        </div>

        <div class="section">
            <h2>3. è°ƒè¯•æ—¥å¿—</h2>
            <button onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
            <div id="debug-logs"></div>
        </div>
    </div>

    <script>
        const PYTHON_API_BASE = 'http://localhost:8091/api';
        
        // æ¨¡æ‹Ÿenhanced-chat-records.htmlçš„å…¨å±€å˜é‡
        const currentData = {
            currentDevice: null,
            currentSession: null,
            sessions: []
        };
        
        const pagination = {
            currentPage: 1,
            totalPages: 1,
            pageSize: 20
        };

        function log(message, type = 'info') {
            const logsDiv = document.getElementById('debug-logs');
            const timestamp = new Date().toLocaleTimeString();
            const logClass = type === 'error' ? 'error-log' : type === 'success' ? 'success-log' : '';
            logsDiv.innerHTML += `<div class="debug-log ${logClass}">[${timestamp}] ${message}</div>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLogs() {
            document.getElementById('debug-logs').innerHTML = '';
        }

        // ç²¾ç¡®æ¨¡æ‹Ÿenhanced-chat-records.htmlçš„loadDeviceså‡½æ•°
        async function loadDevices() {
            const devicesDiv = document.getElementById('devices-list');
            devicesDiv.innerHTML = '<div class="loading-state">åŠ è½½è®¾å¤‡ä¸­...</div>';
            
            try {
                log('å¼€å§‹åŠ è½½è®¾å¤‡åˆ—è¡¨');
                const response = await fetch(`${PYTHON_API_BASE}/devices`);
                log(`è®¾å¤‡APIå“åº”çŠ¶æ€: ${response.status}`);
                
                const devices = await response.json();
                log(`è®¾å¤‡APIè¿”å›æ•°æ®: ${JSON.stringify(devices)}`);
                
                devicesDiv.innerHTML = '';
                devices.forEach(device => {
                    const deviceDiv = document.createElement('div');
                    deviceDiv.className = 'device-item';
                    deviceDiv.innerHTML = `
                        <div><strong>${device.device_id}</strong></div>
                        <div>${device.device_name || 'æœªå‘½åè®¾å¤‡'}</div>
                    `;
                    deviceDiv.onclick = (event) => selectDevice(device.device_id, device.device_name || 'æœªå‘½åè®¾å¤‡', event);
                    devicesDiv.appendChild(deviceDiv);
                });
                
                log(`æˆåŠŸåŠ è½½ ${devices.length} ä¸ªè®¾å¤‡`, 'success');
            } catch (error) {
                devicesDiv.innerHTML = `<div class="error-state">åŠ è½½è®¾å¤‡å¤±è´¥: ${error.message}</div>`;
                log(`åŠ è½½è®¾å¤‡å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // ç²¾ç¡®æ¨¡æ‹Ÿenhanced-chat-records.htmlçš„selectDeviceå‡½æ•°
        async function selectDevice(deviceId, deviceName, event) {
            log(`selectDeviceè¢«è°ƒç”¨: deviceId=${deviceId}, deviceName=${deviceName}`);
            
            // æ›´æ–°UIçŠ¶æ€
            document.querySelectorAll('.device-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.device-item').classList.add('active');

            currentData.currentDevice = { id: deviceId, name: deviceName };
            log(`currentData.currentDeviceè®¾ç½®ä¸º: ${JSON.stringify(currentData.currentDevice)}`);
            
            // æ›´æ–°å¤´éƒ¨ä¿¡æ¯
            document.getElementById('current-device-info').textContent = `${deviceId} (${deviceName})`;
            
            // é‡ç½®ä¼šè¯å’Œæ¶ˆæ¯
            currentData.currentSession = null;
            log('é‡ç½®currentSessionä¸ºnull');
            
            // åŠ è½½ä¼šè¯åˆ—è¡¨
            log(`å‡†å¤‡è°ƒç”¨loadSessions(${deviceId})`);
            await loadSessions(deviceId);
        }

        // ç²¾ç¡®æ¨¡æ‹Ÿenhanced-chat-records.htmlçš„loadSessionså‡½æ•°
        async function loadSessions(deviceId, page = 1) {
            log(`loadSessionsè¢«è°ƒç”¨: deviceId=${deviceId}, page=${page}`);
            
            const container = document.getElementById('sessions-list');
            container.innerHTML = `
                <div class="loading-state">
                    <div>ğŸ”„</div>
                    <div>åŠ è½½ä¼šè¯åˆ—è¡¨...</div>
                </div>
            `;
            log('sessions-listè®¾ç½®ä¸ºåŠ è½½çŠ¶æ€');

            try {
                const url = `${PYTHON_API_BASE}/device/${deviceId}/sessions?page=${page}&per_page=${pagination.pageSize}`;
                log(`å‡†å¤‡è¯·æ±‚URL: ${url}`);
                
                const response = await fetch(url);
                log(`ä¼šè¯APIå“åº”çŠ¶æ€: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                log(`ä¼šè¯APIè¿”å›åŸå§‹æ•°æ®: ${JSON.stringify(result)}`);
                
                if (result.success) {
                    log('APIè¿”å›success=true');
                    currentData.sessions = result.data.list || [];
                    log(`è®¾ç½®currentData.sessions: ${JSON.stringify(currentData.sessions)}`);
                    
                    pagination.currentPage = page;
                    pagination.totalPages = result.data.pagination?.pages || 1;
                    log(`æ›´æ–°åˆ†é¡µä¿¡æ¯: currentPage=${pagination.currentPage}, totalPages=${pagination.totalPages}`);
                    
                    log('å‡†å¤‡è°ƒç”¨renderSessions()');
                    renderSessions();
                    
                    // æ›´æ–°ä¼šè¯æ•°é‡æ˜¾ç¤º
                    const totalCount = result.data.pagination?.total || 0;
                    log(`ä¼šè¯æ€»æ•°: ${totalCount}`);
                } else {
                    throw new Error(result.message || 'åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                log(`loadSessionså‡ºé”™: ${error.message}`, 'error');
                console.error('åŠ è½½ä¼šè¯å¤±è´¥:', error);
                container.innerHTML = `
                    <div class="error-state">
                        <div>âŒ</div>
                        <p>åŠ è½½ä¼šè¯å¤±è´¥: ${error.message}</p>
                        <button onclick="loadSessions('${deviceId}', ${page})">é‡è¯•</button>
                    </div>
                `;
            }
        }

        // ç²¾ç¡®æ¨¡æ‹Ÿenhanced-chat-records.htmlçš„renderSessionså‡½æ•°
        function renderSessions() {
            log(`renderSessionsè¢«è°ƒç”¨ï¼Œå½“å‰sessionsæ•°é‡: ${currentData.sessions ? currentData.sessions.length : 0}`);
            
            const container = document.getElementById('sessions-list');
            
            if (!currentData.sessions || currentData.sessions.length === 0) {
                log('sessionsä¸ºç©ºï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€');
                container.innerHTML = `
                    <div class="empty-state">
                        <div>ğŸ’¬</div>
                        <p>æš‚æ— ä¼šè¯è®°å½•</p>
                    </div>
                `;
                return;
            }

            log('å¼€å§‹æ¸²æŸ“sessions');
            const html = currentData.sessions.map((session, index) => {
                log(`æ¸²æŸ“session ${index}: ${JSON.stringify(session)}`);
                return `
                    <div class="session-item" onclick="selectSession('${session.session_id}')">
                        <div><strong>ä¼šè¯ID:</strong> ${session.session_id}</div>
                        <div><strong>åˆ›å»ºæ—¶é—´:</strong> ${session.created_at || 'æœªçŸ¥'}</div>
                        <div><strong>æœ€åæ¶ˆæ¯:</strong> ${session.last_message_at || 'æœªçŸ¥'}</div>
                        <div><strong>æ¶ˆæ¯æ•°é‡:</strong> ${session.chat_count || 0}</div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
            log(`æˆåŠŸæ¸²æŸ“ ${currentData.sessions.length} ä¸ªä¼šè¯`, 'success');
        }

        function selectSession(sessionId) {
            log(`é€‰æ‹©ä¼šè¯: ${sessionId}`);
            currentData.currentSession = sessionId;
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨åŠ è½½è®¾å¤‡
        document.addEventListener('DOMContentLoaded', function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–');
            loadDevices();
        });
    </script>
</body>
</html>