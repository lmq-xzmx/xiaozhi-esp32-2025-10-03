<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ€ç»ˆéªŒè¯ - Sessions List åŠŸèƒ½</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .device-item { padding: 12px; margin: 5px 0; background: #f8f9fa; cursor: pointer; border: 1px solid #dee2e6; border-radius: 4px; transition: all 0.2s; }
        .device-item:hover { background: #e9ecef; }
        .device-item.active { background: #007bff; color: white; }
        .device-name { font-weight: bold; margin-bottom: 4px; }
        .device-info { font-size: 12px; color: #666; }
        .device-item.active .device-info { color: #cce7ff; }
        .session-item { padding: 12px; margin: 5px 0; background: #fff; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; transition: all 0.2s; }
        .session-item:hover { background: #f8f9fa; border-color: #007bff; }
        .session-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .session-id { font-weight: bold; color: #007bff; }
        .session-time { font-size: 12px; color: #666; }
        .session-stats { font-size: 12px; color: #28a745; }
        .loading-state { text-align: center; padding: 30px; color: #666; }
        .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-state { text-align: center; padding: 30px; color: #dc3545; }
        .empty-state { text-align: center; padding: 30px; color: #6c757d; }
        #sessions-list { min-height: 200px; border: 2px solid #007bff; padding: 15px; border-radius: 5px; background: #f8f9fa; }
        .debug-log { background: #f8f9fa; padding: 8px; margin: 3px 0; font-family: 'Courier New', monospace; font-size: 11px; border-left: 3px solid #007bff; border-radius: 0 3px 3px 0; }
        .error-log { border-left-color: #dc3545; background: #f8d7da; }
        .success-log { border-left-color: #28a745; background: #d4edda; }
        .warning-log { border-left-color: #ffc107; background: #fff3cd; }
        .status-bar { background: #e9ecef; padding: 10px; border-radius: 5px; margin-bottom: 15px; }
        .btn { padding: 8px 16px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn:hover { opacity: 0.8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Sessions List æœ€ç»ˆéªŒè¯</h1>
        
        <div class="status-bar">
            <strong>çŠ¶æ€:</strong> <span id="overall-status">åˆå§‹åŒ–ä¸­...</span> | 
            <strong>APIæœåŠ¡å™¨:</strong> <span id="api-status">æ£€æŸ¥ä¸­...</span> | 
            <strong>å½“å‰è®¾å¤‡:</strong> <span id="current-device-status">æ— </span>
        </div>

        <div class="section">
            <h2>ğŸ“± è®¾å¤‡åˆ—è¡¨</h2>
            <div id="devices-list">
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <div>æ­£åœ¨åŠ è½½è®¾å¤‡åˆ—è¡¨...</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ’¬ Sessions List (æ ¸å¿ƒæµ‹è¯•åŒºåŸŸ)</h2>
            <div id="sessions-list">
                <div class="empty-state">
                    <div style="font-size: 48px;">ğŸ“‹</div>
                    <p>è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè®¾å¤‡æ¥æŸ¥çœ‹ä¼šè¯åˆ—è¡¨</p>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ”§ è°ƒè¯•æ§åˆ¶å°</h2>
            <button class="btn btn-secondary" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
            <button class="btn btn-primary" onclick="testAllAPIs()">æµ‹è¯•æ‰€æœ‰API</button>
            <button class="btn btn-primary" onclick="forceRefresh()">å¼ºåˆ¶åˆ·æ–°</button>
            <div id="debug-logs" style="max-height: 300px; overflow-y: auto; margin-top: 10px;"></div>
        </div>
    </div>

    <script>
        const PYTHON_API_BASE = 'http://localhost:8091/api';
        
        // å®Œå…¨æ¨¡æ‹Ÿenhanced-chat-records.htmlçš„å…¨å±€å˜é‡ç»“æ„
        const currentData = {
            devices: [],
            currentDevice: null,
            currentSession: null,
            sessions: []
        };
        
        const pagination = {
            currentPage: 1,
            totalPages: 1,
            pageSize: 20
        };

        function updateStatus(status) {
            document.getElementById('overall-status').textContent = status;
        }

        function updateAPIStatus(status) {
            document.getElementById('api-status').textContent = status;
        }

        function updateDeviceStatus(status) {
            document.getElementById('current-device-status').textContent = status;
        }

        function log(message, type = 'info') {
            const logsDiv = document.getElementById('debug-logs');
            const timestamp = new Date().toLocaleTimeString();
            const logClass = type === 'error' ? 'error-log' : 
                           type === 'success' ? 'success-log' : 
                           type === 'warning' ? 'warning-log' : '';
            logsDiv.innerHTML += `<div class="debug-log ${logClass}">[${timestamp}] ${message}</div>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLogs() {
            document.getElementById('debug-logs').innerHTML = '';
        }

        async function testAllAPIs() {
            log('å¼€å§‹æµ‹è¯•æ‰€æœ‰APIç«¯ç‚¹', 'info');
            
            // æµ‹è¯•è®¾å¤‡API
            try {
                const devicesResponse = await fetch(`${PYTHON_API_BASE}/devices`);
                if (devicesResponse.ok) {
                    const devicesData = await devicesResponse.json();
                    log(`âœ… è®¾å¤‡APIæ­£å¸¸: ${devicesData.data?.length || 0} ä¸ªè®¾å¤‡`, 'success');
                    updateAPIStatus('æ­£å¸¸');
                } else {
                    throw new Error(`HTTP ${devicesResponse.status}`);
                }
            } catch (error) {
                log(`âŒ è®¾å¤‡APIå¤±è´¥: ${error.message}`, 'error');
                updateAPIStatus('å¼‚å¸¸');
                return;
            }

            // æµ‹è¯•ä¼šè¯API
            try {
                const testDeviceId = '58:8c:81:65:52:48';
                const sessionsResponse = await fetch(`${PYTHON_API_BASE}/device/${testDeviceId}/sessions`);
                if (sessionsResponse.ok) {
                    const sessionsData = await sessionsResponse.json();
                    log(`âœ… ä¼šè¯APIæ­£å¸¸: ${sessionsData.data?.list?.length || 0} ä¸ªä¼šè¯`, 'success');
                } else {
                    throw new Error(`HTTP ${sessionsResponse.status}`);
                }
            } catch (error) {
                log(`âŒ ä¼šè¯APIå¤±è´¥: ${error.message}`, 'error');
            }
        }

        function forceRefresh() {
            log('å¼ºåˆ¶åˆ·æ–°æ‰€æœ‰æ•°æ®', 'info');
            currentData.devices = [];
            currentData.currentDevice = null;
            currentData.sessions = [];
            updateDeviceStatus('æ— ');
            loadDevices();
        }

        // å®Œå…¨æ¨¡æ‹Ÿenhanced-chat-records.htmlçš„escapeHtmlå‡½æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ¨¡æ‹ŸgetChatCountå‡½æ•°
        function getChatCount(deviceId) {
            return '?'; // ç®€åŒ–å®ç°
        }

        // å®Œå…¨æ¨¡æ‹Ÿenhanced-chat-records.htmlçš„loadDeviceså‡½æ•°
        async function loadDevices() {
            log('ğŸ”„ å¼€å§‹åŠ è½½è®¾å¤‡åˆ—è¡¨');
            updateStatus('åŠ è½½è®¾å¤‡ä¸­...');
            
            try {
                const response = await fetch(`${PYTHON_API_BASE}/devices`);
                log(`è®¾å¤‡APIå“åº”çŠ¶æ€: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                log(`è®¾å¤‡APIåŸå§‹å“åº”: ${JSON.stringify(result).substring(0, 200)}...`);
                
                // å®Œå…¨æŒ‰ç…§enhanced-chat-records.htmlçš„é€»è¾‘
                currentData.devices = result.data || result;
                log(`è®¾ç½®currentData.devicesï¼Œæ•°é‡: ${currentData.devices.length}`);
                
                renderDevices();
                updateStatus('è®¾å¤‡åŠ è½½å®Œæˆ');
                updateAPIStatus('æ­£å¸¸');
                
            } catch (error) {
                log(`âŒ åŠ è½½è®¾å¤‡å¤±è´¥: ${error.message}`, 'error');
                updateStatus('è®¾å¤‡åŠ è½½å¤±è´¥');
                updateAPIStatus('å¼‚å¸¸');
                
                document.getElementById('devices-list').innerHTML = `
                    <div class="error-state">
                        <div style="font-size: 48px;">âŒ</div>
                        <p>åŠ è½½è®¾å¤‡å¤±è´¥: ${error.message}</p>
                        <button class="btn btn-primary" onclick="loadDevices()">é‡è¯•</button>
                    </div>
                `;
            }
        }

        // å®Œå…¨æ¨¡æ‹Ÿenhanced-chat-records.htmlçš„renderDeviceså‡½æ•°
        function renderDevices(filteredDevices = null) {
            log(`ğŸ¨ å¼€å§‹æ¸²æŸ“è®¾å¤‡åˆ—è¡¨`);
            
            const devices = filteredDevices || currentData.devices;
            const container = document.getElementById('devices-list');
            
            if (!devices || devices.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 48px;">ğŸ“±</div>
                        <p>æš‚æ— è®¾å¤‡</p>
                    </div>
                `;
                log('âš ï¸ è®¾å¤‡åˆ—è¡¨ä¸ºç©º', 'warning');
                return;
            }

            const html = devices.map(device => {
                log(`æ¸²æŸ“è®¾å¤‡: ${device.id} - ${device.alias || device.mac_address}`);
                return `
                    <div class="device-item" onclick="selectDevice('${device.id}', '${escapeHtml(device.alias || device.mac_address)}')">
                        <div class="device-name">${escapeHtml(device.alias || device.mac_address)}</div>
                        <div class="device-info">
                            <span>MAC: ${device.mac_address}</span>
                            <span class="session-count">${getChatCount(device.id)} æ¡</span>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
            log(`âœ… æˆåŠŸæ¸²æŸ“ ${devices.length} ä¸ªè®¾å¤‡`, 'success');
        }

        // å®Œå…¨æ¨¡æ‹Ÿenhanced-chat-records.htmlçš„selectDeviceå‡½æ•°
        async function selectDevice(deviceId, deviceName) {
            log(`ğŸ¯ é€‰æ‹©è®¾å¤‡: ${deviceId} (${deviceName})`);
            
            // æ›´æ–°UIçŠ¶æ€
            document.querySelectorAll('.device-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.device-item').classList.add('active');

            currentData.currentDevice = { id: deviceId, name: deviceName };
            log(`è®¾ç½®currentData.currentDevice: ${JSON.stringify(currentData.currentDevice)}`);
            
            updateDeviceStatus(`${deviceId} (${deviceName})`);
            updateStatus('åŠ è½½ä¼šè¯ä¸­...');
            
            // é‡ç½®ä¼šè¯å’Œæ¶ˆæ¯
            currentData.currentSession = null;
            log('é‡ç½®currentSessionä¸ºnull');
            
            // åŠ è½½ä¼šè¯åˆ—è¡¨
            log(`ğŸš€ å‡†å¤‡è°ƒç”¨loadSessions(${deviceId})`);
            await loadSessions(deviceId);
        }

        // å®Œå…¨æ¨¡æ‹Ÿenhanced-chat-records.htmlçš„loadSessionså‡½æ•°
        async function loadSessions(deviceId, page = 1) {
            log(`ğŸ“‹ loadSessionsè¢«è°ƒç”¨: deviceId=${deviceId}, page=${page}`);
            
            const container = document.getElementById('sessions-list');
            container.innerHTML = `
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">åŠ è½½ä¼šè¯åˆ—è¡¨...</div>
                </div>
            `;
            log('sessions-listè®¾ç½®ä¸ºåŠ è½½çŠ¶æ€');

            try {
                const url = `${PYTHON_API_BASE}/device/${deviceId}/sessions?page=${page}&per_page=${pagination.pageSize}`;
                log(`ğŸ“¡ è¯·æ±‚URL: ${url}`);
                
                const response = await fetch(url);
                log(`ä¼šè¯APIå“åº”çŠ¶æ€: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                log(`ä¼šè¯APIåŸå§‹å“åº”: ${JSON.stringify(result)}`);
                
                if (result.success) {
                    log('âœ… APIè¿”å›success=true');
                    currentData.sessions = result.data.list || [];
                    log(`è®¾ç½®currentData.sessionsï¼Œæ•°é‡: ${currentData.sessions.length}`);
                    
                    pagination.currentPage = page;
                    pagination.totalPages = result.data.pagination?.pages || 1;
                    log(`æ›´æ–°åˆ†é¡µ: currentPage=${pagination.currentPage}, totalPages=${pagination.totalPages}`);
                    
                    log('ğŸ¨ å‡†å¤‡è°ƒç”¨renderSessions()');
                    renderSessions();
                    updateStatus('ä¼šè¯åŠ è½½å®Œæˆ');
                    
                    // æ›´æ–°ä¼šè¯æ•°é‡æ˜¾ç¤º
                    const totalCount = result.data.pagination?.total || 0;
                    log(`ğŸ“Š ä¼šè¯æ€»æ•°: ${totalCount}`, 'success');
                } else {
                    throw new Error(result.message || 'åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                log(`âŒ loadSessionså‡ºé”™: ${error.message}`, 'error');
                updateStatus('ä¼šè¯åŠ è½½å¤±è´¥');
                console.error('åŠ è½½ä¼šè¯å¤±è´¥:', error);
                container.innerHTML = `
                    <div class="error-state">
                        <div style="font-size: 48px;">âŒ</div>
                        <p>åŠ è½½ä¼šè¯å¤±è´¥: ${error.message}</p>
                        <button class="btn btn-primary" onclick="loadSessions('${deviceId}', ${page})">é‡è¯•</button>
                    </div>
                `;
            }
        }

        // å®Œå…¨æ¨¡æ‹Ÿenhanced-chat-records.htmlçš„renderSessionså‡½æ•°
        function renderSessions() {
            log(`ğŸ¨ renderSessionsè¢«è°ƒç”¨ï¼Œsessionsæ•°é‡: ${currentData.sessions ? currentData.sessions.length : 0}`);
            
            const container = document.getElementById('sessions-list');
            
            if (!currentData.sessions || currentData.sessions.length === 0) {
                log('âš ï¸ sessionsä¸ºç©ºï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€', 'warning');
                container.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 48px;">ğŸ’¬</div>
                        <p>è¯¥è®¾å¤‡æš‚æ— ä¼šè¯è®°å½•</p>
                    </div>
                `;
                return;
            }

            log('ğŸ¨ å¼€å§‹æ¸²æŸ“sessions');
            const html = currentData.sessions.map((session, index) => {
                log(`æ¸²æŸ“session ${index}: ${session.session_id}`);
                return `
                    <div class="session-item" onclick="selectSession('${session.session_id}')">
                        <div class="session-header">
                            <div class="session-id">${session.session_id}</div>
                            <div class="session-time">${session.created_at || 'æœªçŸ¥æ—¶é—´'}</div>
                        </div>
                        <div class="session-stats">
                            ğŸ’¬ ${session.chat_count || 0} æ¡æ¶ˆæ¯ | 
                            ğŸ•’ æœ€åæ´»åŠ¨: ${session.last_message_at || 'æœªçŸ¥'}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
            log(`âœ… æˆåŠŸæ¸²æŸ“ ${currentData.sessions.length} ä¸ªä¼šè¯`, 'success');
        }

        function selectSession(sessionId) {
            log(`ğŸ¯ é€‰æ‹©ä¼šè¯: ${sessionId}`);
            currentData.currentSession = sessionId;
            
            // é«˜äº®é€‰ä¸­çš„ä¼šè¯
            document.querySelectorAll('.session-item').forEach(item => {
                item.style.background = '#fff';
            });
            event.target.closest('.session-item').style.background = '#e3f2fd';
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–');
            updateStatus('åˆå§‹åŒ–ä¸­...');
            loadDevices();
        });
    </script>
</body>
</html>