# ðŸŽ¯ é¦–å­—å»¶è¿Ÿä¼˜åŒ–å®Œæ•´æ–¹æ¡ˆ

## ðŸ“Š å»¶è¿Ÿåˆ†æžç»“æžœ

æ ¹æ®å®žé™…æµ‹è¯•ï¼Œå„çŽ¯èŠ‚å»¶è¿Ÿè´¡çŒ®å¦‚ä¸‹ï¼š

| çŽ¯èŠ‚ | å½“å‰å»¶è¿Ÿ | å»¶è¿Ÿå æ¯” | ä¼˜åŒ–æ½œåŠ› | ä¼˜åŒ–åŽé¢„æœŸ |
|------|----------|----------|----------|------------|
| **LLMç”Ÿæˆ** | 300ms | 44.6% | ðŸ”´ **æœ€é«˜** | 100-150ms |
| **ASRè¯†åˆ«** | 253ms | 37.5% | ðŸŸ¡ **é«˜** | 100-150ms |
| TTSåˆæˆ | 100ms | 14.9% | ðŸŸ  ä¸­ç­‰ | 50-80ms |
| VADæ£€æµ‹ | 20ms | 3.0% | âœ… è‰¯å¥½ | 15-20ms |
| **æ€»å»¶è¿Ÿ** | **674ms** | 100% | - | **265-400ms** |

**ðŸŽ¯ ä¼˜åŒ–ç›®æ ‡ï¼šå°†é¦–å­—å»¶è¿Ÿä»Ž674msé™ä½Žåˆ°265-400msï¼Œå‡å°‘40-60%**

## ðŸ”§ ä¼˜åŒ–æ–¹æ¡ˆè¯¦è§£

### 1. LLMä¼˜åŒ– (æœ€é«˜ä¼˜å…ˆçº§) ðŸ”´

**é—®é¢˜åˆ†æžï¼š**
- LLMé¦–tokenç”Ÿæˆæ˜¯æœ€å¤§ç“¶é¢ˆï¼Œå æ€»å»¶è¿Ÿ44.6%
- æ¨¡åž‹æŽ¨ç†ã€ä¸Šä¸‹æ–‡å¤„ç†ã€ç”Ÿæˆç­–ç•¥éƒ½å½±å“é¦–å­—å»¶è¿Ÿ

**ä¼˜åŒ–ç­–ç•¥ï¼š**

#### A. é¦–Tokenä¼˜å…ˆç”Ÿæˆ
```bash
# æ¿€è¿›ä¼˜åŒ–é…ç½®
export LLM_MAX_NEW_TOKENS=1          # é¦–æ¬¡åªç”Ÿæˆ1ä¸ªtoken
export LLM_TEMPERATURE=0.0           # å®Œå…¨ç¡®å®šæ€§ï¼Œæœ€å¿«ç”Ÿæˆ
export LLM_TOP_K=1                   # åªè€ƒè™‘æœ€å¯èƒ½çš„token
export LLM_DO_SAMPLE=false           # å…³é—­é‡‡æ ·ï¼Œä½¿ç”¨è´ªå¿ƒè§£ç 
export LLM_STREAM_FIRST_TOKEN=true   # ä¼˜å…ˆæµå¼è¾“å‡ºé¦–token
```

#### B. æ¨¡åž‹å’Œç¡¬ä»¶ä¼˜åŒ–
```bash
export TORCH_COMPILE=true            # PyTorchç¼–è¯‘ä¼˜åŒ–
export FLASH_ATTENTION=true          # Flash AttentionåŠ é€Ÿ
export LLM_TORCH_DTYPE=float16       # FP16ç²¾åº¦
export CUDA_VISIBLE_DEVICES=0        # ä¸“ç”¨GPU
```

#### C. ç¼“å­˜å’Œé¢„çƒ­
```bash
export LLM_ENABLE_CACHE=true         # å¯ç”¨å“åº”ç¼“å­˜
export LLM_CACHE_SIZE_MB=512         # 512MBç¼“å­˜
export LLM_MODEL_WARMUP=true         # æ¨¡åž‹é¢„çƒ­
```

**é¢„æœŸæ•ˆæžœï¼š** 300ms â†’ 100-150ms (å‡å°‘50-67%)

### 2. ASRä¼˜åŒ– (é«˜ä¼˜å…ˆçº§) ðŸŸ¡

**é—®é¢˜åˆ†æžï¼š**
- ASRè¯†åˆ«æ˜¯ç¬¬äºŒå¤§ç“¶é¢ˆï¼Œå æ€»å»¶è¿Ÿ37.5%
- éŸ³é¢‘å¤„ç†ã€æ¨¡åž‹æŽ¨ç†ã€é˜Ÿåˆ—ç­‰å¾…éƒ½å½±å“å»¶è¿Ÿ

**ä¼˜åŒ–ç­–ç•¥ï¼š**

#### A. æµå¼å¤„ç†ä¼˜åŒ–
```bash
# å¿«é€Ÿå“åº”é…ç½®
export ASR_ENABLE_STREAMING=true     # å¯ç”¨æµå¼è¯†åˆ«
export ASR_CHUNK_SIZE=80             # 5mséŸ³é¢‘å—ï¼Œæžä½Žå»¶è¿Ÿ
export ASR_OVERLAP_SIZE=40           # 2.5msé‡å 
export ASR_BATCH_SIZE=1              # å•æ ·æœ¬å¤„ç†
```

#### B. å¹¶å‘å’Œæ€§èƒ½ä¼˜åŒ–
```bash
export ASR_MAX_CONCURRENT=200        # é«˜å¹¶å‘æ”¯æŒ
export ASR_WORKER_THREADS=16         # å¢žåŠ å·¥ä½œçº¿ç¨‹
export ASR_ENABLE_FP16=true          # FP16åŠ é€Ÿ
export ASR_ZERO_COPY=true            # é›¶æ‹·è´ä¼˜åŒ–
```

#### C. VADå’Œé¢„å¤„ç†ä¼˜åŒ–
```bash
export ASR_VAD_THRESHOLD=0.2         # æ›´ä½ŽVADé˜ˆå€¼ï¼Œæ›´å¿«æ£€æµ‹
export ASR_SILENCE_TIMEOUT=0.3       # 0.3ç§’é™éŸ³è¶…æ—¶
export ASR_SKIP_NORMALIZATION=true   # è·³è¿‡éŸ³é¢‘æ ‡å‡†åŒ–
```

**é¢„æœŸæ•ˆæžœï¼š** 253ms â†’ 100-150ms (å‡å°‘40-60%)

### 3. TTSä¼˜åŒ– (ä¸­ç­‰ä¼˜å…ˆçº§) ðŸŸ 

**ä¼˜åŒ–ç­–ç•¥ï¼š**
```bash
export TTS_STREAMING=true            # æµå¼åˆæˆ
export TTS_CHUNK_SIZE=512            # å°å—è¾“å‡º
export TTS_ENABLE_CACHE=true         # ç¼“å­˜å¸¸è§å›žå¤
export TTS_FAST_VOCODER=true         # å¿«é€Ÿå£°ç å™¨
```

**é¢„æœŸæ•ˆæžœï¼š** 100ms â†’ 50-80ms (å‡å°‘20-50%)

### 4. VADä¼˜åŒ– (ä½Žä¼˜å…ˆçº§) âœ…

**ä¼˜åŒ–ç­–ç•¥ï¼š**
```bash
export VAD_BUFFER_SIZE=160           # å‡å°‘ç¼“å†²
export VAD_ENABLE_FP16=true          # FP16åŠ é€Ÿ
export VAD_FAST_MODE=true            # å¿«é€Ÿæ¨¡å¼
```

**é¢„æœŸæ•ˆæžœï¼š** 20ms â†’ 15-20ms (å‡å°‘0-25%)

## ðŸš€ å¿«é€Ÿéƒ¨ç½²æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šä¿å®ˆä¼˜åŒ– (æŽ¨è)
```bash
# å¯åŠ¨ä¿å®ˆä¼˜åŒ–é…ç½®
cd /root/xiaozhi-server

# LLMåŸºç¡€ä¼˜åŒ–
export LLM_MAX_NEW_TOKENS=1
export LLM_TEMPERATURE=0.1
export LLM_STREAM_FIRST_TOKEN=true
export LLM_ENABLE_CACHE=true

# ASRå¿«é€Ÿå“åº”
export ASR_CHUNK_SIZE=160
export ASR_BATCH_SIZE=1
export ASR_ENABLE_STREAMING=true
export ASR_MAX_CONCURRENT=150

# å¯åŠ¨æœåŠ¡
python3 services/asr_service.py &
python3 services/llm_service.py &
```

**é¢„æœŸå»¶è¿Ÿï¼š** 674ms â†’ 400-450ms (å‡å°‘33-40%)

### æ–¹æ¡ˆäºŒï¼šæ¿€è¿›ä¼˜åŒ– (é«˜æ€§èƒ½)
```bash
# ä½¿ç”¨é¢„ç”Ÿæˆçš„æ¿€è¿›é…ç½®
cd /root/xiaozhi-server

# åº”ç”¨LLMæ¿€è¿›ä¼˜åŒ–
source config/llm_aggressive_config.yaml

# åº”ç”¨ASRæžé™ä¼˜åŒ–
bash optimization/asr_extreme/start_asr_extreme.sh &

# å¯åŠ¨LLMæœåŠ¡
python3 services/llm_service.py &
```

**é¢„æœŸå»¶è¿Ÿï¼š** 674ms â†’ 265-350ms (å‡å°‘48-61%)

### æ–¹æ¡ˆä¸‰ï¼šæµå¼ä¼˜åŒ– (æœ€ä½³ä½“éªŒ)
```bash
# å¯ç”¨å®Œæ•´æµå¼å¤„ç†
export LLM_STREAM_FIRST_TOKEN=true
export ASR_ENABLE_STREAMING=true
export TTS_STREAMING=true
export PIPELINE_STREAMING=true

# å¹¶è¡Œå¤„ç†
export ENABLE_PIPELINE_PARALLEL=true
export VAD_ASR_PARALLEL=true
```

**é¢„æœŸå»¶è¿Ÿï¼š** 674ms â†’ 200-300ms (å‡å°‘55-70%)

## ðŸ“ˆ æ€§èƒ½ç›‘æŽ§

### å…³é”®æŒ‡æ ‡ç›‘æŽ§
```bash
# åˆ›å»ºç›‘æŽ§è„šæœ¬
cat > monitor_latency.sh << 'EOF'
#!/bin/bash
while true; do
    echo "=== $(date) ==="
    echo "LLMé¦–Tokenå»¶è¿Ÿ: $(curl -s http://localhost:8002/metrics | grep first_token_latency)"
    echo "ASRè¯†åˆ«å»¶è¿Ÿ: $(curl -s http://localhost:8001/metrics | grep recognition_latency)"
    echo "æ€»æµæ°´çº¿å»¶è¿Ÿ: $(curl -s http://localhost:8000/metrics | grep pipeline_latency)"
    echo "ç³»ç»Ÿè´Ÿè½½: $(uptime)"
    echo ""
    sleep 10
done
EOF

chmod +x monitor_latency.sh
./monitor_latency.sh
```

### æ€§èƒ½åŸºå‡†æµ‹è¯•
```bash
# è¿è¡Œå»¶è¿Ÿåˆ†æžå·¥å…·
cd /root/xiaozhi-server/performance_tester
python3 first_word_latency_analyzer.py

# å¯¹æ¯”ä¼˜åŒ–å‰åŽæ•ˆæžœ
python3 concurrent_device_tester.py --devices 30 --duration 60
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. èµ„æºæ¶ˆè€—
- **å†…å­˜ä½¿ç”¨ï¼š** æ¿€è¿›ä¼˜åŒ–å¯èƒ½å¢žåŠ 20-30%å†…å­˜ä½¿ç”¨
- **CPUä½¿ç”¨ï¼š** æµå¼å¤„ç†ä¼šå¢žåŠ CPUè´Ÿè½½
- **GPUä½¿ç”¨ï¼š** FP16ä¼˜åŒ–éœ€è¦æ”¯æŒçš„GPU

### 2. ç²¾åº¦æƒè¡¡
- **LLMç²¾åº¦ï¼š** é™ä½Žtemperatureå¯èƒ½å½±å“å›žå¤å¤šæ ·æ€§
- **ASRç²¾åº¦ï¼š** å°éŸ³é¢‘å—å¯èƒ½å½±å“è¯†åˆ«å‡†ç¡®çŽ‡
- **å»ºè®®ï¼š** åœ¨æµ‹è¯•çŽ¯å¢ƒéªŒè¯ç²¾åº¦æŸå¤±

### 3. ç¨³å®šæ€§è€ƒè™‘
- **å¹¶å‘é™åˆ¶ï¼š** é«˜å¹¶å‘å¯èƒ½å¯¼è‡´ç³»ç»Ÿä¸ç¨³å®š
- **å†…å­˜æ³„æ¼ï¼š** é•¿æ—¶é—´è¿è¡Œéœ€ç›‘æŽ§å†…å­˜ä½¿ç”¨
- **é”™è¯¯å¤„ç†ï¼š** å¢žå¼ºè¶…æ—¶å’Œé‡è¯•æœºåˆ¶

## ðŸŽ¯ å®žæ–½å»ºè®®

### é˜¶æ®µä¸€ï¼šåŸºç¡€ä¼˜åŒ– (1-2å¤©)
1. éƒ¨ç½²LLMé¦–tokenä¼˜åŒ–
2. å¯ç”¨ASRæµå¼å¤„ç†
3. ç›‘æŽ§æ€§èƒ½æŒ‡æ ‡

### é˜¶æ®µäºŒï¼šæ·±åº¦ä¼˜åŒ– (3-5å¤©)
1. åº”ç”¨æ¿€è¿›é…ç½®
2. è°ƒä¼˜å‚æ•°
3. åŽ‹åŠ›æµ‹è¯•éªŒè¯

### é˜¶æ®µä¸‰ï¼šç³»ç»Ÿä¼˜åŒ– (1å‘¨)
1. æµå¼å¤„ç†é›†æˆ
2. å¹¶è¡Œå¤„ç†ä¼˜åŒ–
3. ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²

**ðŸŽ‰ é¢„æœŸæœ€ç»ˆæ•ˆæžœï¼šé¦–å­—å»¶è¿Ÿä»Ž674msé™ä½Žåˆ°200-400msï¼Œæå‡40-70%çš„å“åº”é€Ÿåº¦ï¼**